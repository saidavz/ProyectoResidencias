<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Bill of Materials (BOM)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Barra de navegación -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-gradient">
        <div class="container-fluid px-4">
            <a href="index.html" class="p-0 me-4">
                <img src="logo.png" alt="Logo" height="40">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu"
                aria-controls="navbarMenu" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarMenu">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="http://localhost:3000">Home</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            BOM
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="bom.html">Upload BOM</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item active" href="bomView.html">View BOM</a></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="recordPurchase.html">Register Purchase</a></li>
                    <li class="nav-item"><a class="nav-link" href="purchaseTracking.html">Purchase Tracking</a></li>
                                        <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            Inventory
                        </a>
                        <ul class="dropdown-menu w-100 text-center" aria-labelledby="dropdownBom">
                            <li><a class="dropdown-item" href="createQr.html">Create QR Codes</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="io.html">Register Inbound And Outbound</a></li><li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="stock.html">View Inventory</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
            <div class="d-flex align-items-center">
                <i class="bi bi-list-check fs-4 me-2 text-white"></i>
                <span class="h4 mb-0 text-white">Bill of Materials</span>
            </div>
        </div>
    </nav>
    <main class="container my-5">
        <!-- Contenedor de visualización -->
        <h2 class="mb-4 text-center text-white" style="font-weight: bold;">Bill of Materials (BOM)</h2>
        <div class="card p-4 mb-5 static-filter-card" style="position: relative; z-index: 1010; overflow: visible;">
            <div class="row d-flex justify-content-center">
                <div class="col-md-6" style="position: relative; z-index: 1010; overflow: visible;">
                    <label for="projectSearchBomView" class="form-label">Search Project</label>
                    <input type="text" id="projectSearchBomView" class="form-control" placeholder="Search project..."
                        autocomplete="off">
                    <div id="projectSuggestionsBomView" class="bg-light text-dark"
                        style="position: absolute; top: calc(100% + 5px); left: 0; right: 0; z-index: 2000; border: 1px solid #ccc; display: none; max-height: 300px; overflow-y: auto; border-radius: 4px; box-shadow: 0 8px 16px rgba(0,0,0,0.3); background-color: white;">
                    </div>
                </div>
            </div>
        </div>
        <!-- Tabla del BOM -->
        <div class="enhanced-table" style="position: relative; z-index: 1;">
            <div class="table-responsive">
                <table class="table table-hover align-middle">

                    <thead class="table-dark">
                        <tr>
                            <th>Project</th>
                            <th>Type</th>
                            <th>No. Part</th>
                            <th>Description</th>
                            <th>Brand</th>
                            <th>Content</th>
                            <th>Unit</th>
                            <th>Number of packages</th>
                            <th>Total Quantity Required</th>
                        </tr>
                    </thead>
                    <tbody id="bomTableBody">
                        <tr>
                            <td colspan="9" class="text-center">Cargando datos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer class="text-center py-3 text-white bg-gradient mt-5">
        Purchase-Inventory Management System - BRK. Resideo.
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const BASE = 'http://localhost:3000/api';
            const projectSearchInput = document.getElementById('projectSearchBomView');
            const projectSuggestions = document.getElementById('projectSuggestionsBomView');
            let allProjects = [];
            // Función para normalizar acentos y convertir a minúsculas
            function normalizeText(text) {
                return text
                    .toLowerCase()
                    .normalize('NFD')
                    .replace(/[\u0300-\u036f]/g, ''); // Elimina marcas diacríticas
            }
            // Cargar todos los proyectos al iniciar
            async function loadAllProjects() {
                try {
                    const res = await fetch(`${BASE}/projects/all`);
                    allProjects = await res.json();
                } catch (err) {
                    console.error('Error loading projects:', err);
                }
            }
            // Buscador de proyectos
            projectSearchInput.addEventListener('input', () => {
                const term = normalizeText(projectSearchInput.value.trim());
                if (!term) {
                    projectSuggestions.style.display = 'none';
                    loadAllBOMData(); // Mostrar todos los BOMs si no hay búsqueda
                    return;
                }
                // Filtrar proyectos excluyendo los que no tengan proyecto asignado
                const filtered = allProjects.filter(p => {
                    const pname = normalizeText(p.name_project || '');
                    const pid = normalizeText((p.no_project || '').toString());
                    // Excluir "Sin asignar"
                    if (pname.includes('sin asignar')) return false;
                    // Incluir si contiene el término en nombre o en no_project (normalizado)
                    return pname.includes(term) || pid.includes(term);
                });

                // Jerarquizar: primero los que empiezan con el término, luego los que lo contienen en otro lado
                const filteredProjects = filtered.sort((a, b) => {
                    const aname = normalizeText(a.name_project || '');
                    const bname = normalizeText(b.name_project || '');
                    const aStartsWith = aname.startsWith(term);
                    const bStartsWith = bname.startsWith(term);
                    // Si uno empieza y el otro no, poner primero al que empieza
                    if (aStartsWith && !bStartsWith) return -1;
                    if (!aStartsWith && bStartsWith) return 1;
                    // Si ambos empiezan (o ninguno), mantener orden alfabético
                    return aname.localeCompare(bname);
                });
                projectSuggestions.innerHTML = '';
                filteredProjects.forEach(project => {
                    const div = document.createElement('div');
                    div.textContent = `${project.no_project} - ${project.name_project}`;
                    div.style.padding = '8px';
                    div.style.cursor = 'pointer';
                    div.style.borderBottom = '1px solid #eee';
                    div.addEventListener('click', () => {
                        projectSearchInput.value = `${project.no_project} - ${project.name_project}`;
                        projectSearchInput.dataset.noProject = project.no_project;
                        projectSuggestions.style.display = 'none';
                        // Cargar BOM filtrado por proyecto
                        loadBOMDataByProject(project.no_project);
                    });
                    div.addEventListener('mouseover', () => {
                        div.style.backgroundColor = '#f0f0f0';
                    });
                    div.addEventListener('mouseout', () => {
                        div.style.backgroundColor = 'transparent';
                    });
                    projectSuggestions.appendChild(div);
                });
                projectSuggestions.style.display = filteredProjects.length ? 'block' : 'none';
            });
            // Ocultar sugerencias al hacer click fuera
            document.addEventListener('click', (e) => {
                if (e.target !== projectSearchInput && !projectSuggestions.contains(e.target)) {
                    projectSuggestions.style.display = 'none';
                }
            });
            // Cargar BOM filtrado por proyecto
            async function loadBOMDataByProject(noProject) {
                let url = `${BASE}/bomView`;
                const params = new URLSearchParams();
                if (noProject) {
                    params.append('no_project', noProject);
                }
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                try {
                    console.log('Fetching BOM URL:', url);
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log('BOM response length:', Array.isArray(data) ? data.length : 'not-array', data);
                    displayBOMData(data);
                } catch (error) {
                    console.error('Error al cargar BOM:', error);
                    document.getElementById('bomTableBody').innerHTML =
                        '<tr><td colspan="9" class="text-center text-danger">Error al cargar los datos</td></tr>';
                }
            }
            // Cargar todos los BOM al inicio
            async function loadAllBOMData() {
                let url = `${BASE}/bomView`;
                try {
                    console.log('Fetching all BOM URL:', url);
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log('BOM response length:', Array.isArray(data) ? data.length : 'not-array', data);
                    displayBOMData(data);
                } catch (error) {
                    console.error('Error al cargar BOM:', error);
                    document.getElementById('bomTableBody').innerHTML =
                        '<tr><td colspan="9" class="text-center text-danger">Error al cargar los datos</td></tr>';
                }
            }
            function displayBOMData(data) {
                const tbody = document.getElementById('bomTableBody');

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center">No materials were found.</td></tr>';
                    return;
                }
                const rows = data.map(item => {
                    const uploadDate = item.upload_date ? new Date(item.upload_date).toLocaleDateString() : 'N/A';
                    return `
                        <tr>
                            <td>${item.name_project}</td>
                            <td>${item.type_p}</td>
                            <td>${item.no_part}</td>
                            <td>${item.description}</td>
                            <td>${item.brand}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unit}</td>
                            <td class="quantity-cell">${item.quantity_requested}</td>
                            <td>${(+item.quantity || 0) * (+item.quantity_requested || 0)}</td>
                        </tr>
                    `;
                }).join('');

                tbody.innerHTML = rows;
            }
            // Cargar proyectos y BOMs al iniciar
            loadAllProjects();
            loadAllBOMData();
        });
    </script>
</body>

</html>