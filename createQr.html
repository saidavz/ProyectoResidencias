<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase System - Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* Resalta el último QR mostrado o regenerado */
        .qr-card-highlight {
            outline: 2px solid #c0c0c0;
            box-shadow: 0 0 12px rgba(192, 192, 192, 0.6);
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-gradient">
        <div class="container-fluid px-4">
            <a href="index.html" class="p-0 me-4">
                <img src="/logo.png" alt="Logo" height="40">
            </a>
            <div class="collapse navbar-collapse" id="navbarMenu">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            BOM
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="bom.html">Upload BOM</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="bomView.html">View BOM</a></li>
                        </ul>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="recordPurchase.html">Register Purchase</a></li>
                    <li class="nav-item"><a class="nav-link" href="purchaseTracking.html">Purchase Tracking</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            Inventory
                        </a>
                        <ul class="dropdown-menu w-100 text-center" aria-labelledby="dropdownBom">
                            <li><a class="dropdown-item" href="createQr.html">Create QR Codes</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="inbound.html">Register Inventory</a></li><li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="stock.html">View Inventory</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="outbound.html">Outbound Inventory</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <main class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <h2 class="mb-4 text-center text-white" style="font-weight: bold;">Create QR Codes</h2>
                <form id="entryForm">
                    <div class="mb-4">
                        <div class="producto-item card p-4 p-md-5">
                            <div class="row">
                                <!-- Select de proyecto con productos en Shopping cart -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label" for="projectSelect">Selecciona un proyecto</label>
                                    <select class="form-select bg-secondary text-light" id="projectSelect"
                                        name="project" required>
                                        <option value="">-- Selecciona un proyecto --</option>
                                    </select>
                                </div>
                                <!-- Campo Rack Number existente -->
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Rack Number</label>
                                    <select class="form-select bg-secondary text-light" name="rackNumber" required>
                                        <option value="">Select Rack Number</option>
                                        <option value="1">1</option>
                                        <option value="2">2</option>
                                        <option value="3">3</option>
                                        <option value="4">4</option>
                                        <option value="5">5</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Tabla de productos por proyecto Shopping cart) -->
                            <div class="mt-4">
                                <div class="entry-table-wrapper hidden" id="projectTableWrapper">
                                    <table class="table entry-products-table" id="projectProductsTable">
                                        <thead>
                                            <tr>
                                                <th>No. Part</th>
                                                <th>Description</th>
                                                <th>QR Code ID</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="projectProductsBody">
                                        </tbody>
                                    </table>
                                </div>
                                <div class="entry-empty-state" id="projectEmptyState">
                                    <i class="bi bi-inbox"></i>
                                    <p class="mt-0 mb-0">No hay productos para el proyecto seleccionado.</p>
                                </div>
                                <!-- Sección de QR Codes Generados -->
                                <div class="mt-4" id="qrCodesSection" style="display: none;">
                                    <h5 class="text-white mb-3">Códigos QR Generados</h5>
                                    <div class="row" id="qrCodesContainer">
                                        <!-- Los QR codes se insertan dinámicamente -->
                                    </div>
                                    <button type="button" class="btn btn-primary btn-lg w-100" onclick="printQRCodes()">
                                        <i class="bi bi-printer me-1" style="align-items: center;"></i> Imprimir QRs
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <!-- Modal de confirmación para regenerar QR -->
    <div class="modal fade" id="confirmQRModal" tabindex="-1" aria-labelledby="confirmQRModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmQRModalLabel">Regenerar QR</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Deseas volver a generar el QR?</p>
                    <p class="text-muted"><small>El código QR permanecerá igual, solo se volverá a mostrar para imprimir.</small></p>
                    <div id="existingQRInfo" class="alert alert-info">
                        <strong>QR Code ID:</strong> <span id="existingQRId"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmRegenerateBtn">Sí, volver a generar</button>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center py-3 text-white bg-gradient mt-5">
        Purchase-Inventory Management System - BRK. Resideo.
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="printQr.js"></script>
    <script>
        // Resaltar navbar según la página actual
        document.addEventListener('DOMContentLoaded', () => {
            const currentPage = window.location.pathname.split('/').pop() || 'index.html';

            if (currentPage === 'entry.html' || currentPage === '') {
                // Resaltar Inventory cuando estamos en entry.html
                const inventoryLinks = document.querySelectorAll('a[href="entry.html"]');
                inventoryLinks.forEach(link => {
                    link.parentElement.parentElement.querySelector('.dropdown-toggle').classList.add('active');
                });
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const baseURL = 'http://localhost:3000';
            const projectSelect = document.getElementById('projectSelect');
            const tableWrapper = document.getElementById('projectTableWrapper');
            const tbody = document.getElementById('projectProductsBody');
            const emptyState = document.getElementById('projectEmptyState');
            const confirmQRModal = new bootstrap.Modal(document.getElementById('confirmQRModal'));
            let currentQRAction = null; // Para guardar la acción pendiente del QR

            let allRows = [];

            // Cargar proyectos que tienen productos en Shopping cart
            fetch(`${baseURL}/api/projects-shopping-cart`)
                .then(res => res.json())
                .then(data => {
                    const options = Array.isArray(data) ? data : [];
                    options.forEach(proj => {
                        const option = document.createElement('option');
                        option.value = proj.no_project;
                        option.textContent = proj.name_project;
                        projectSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading projects:', error);
                });

            // Render helper
            function safe(v) {
                return (v === null || v === undefined || v === '') ? '-' : String(v);
            }

            // Función para obtener QR previo de un producto
            async function getExistingQR(noPart, noProject, rack) {
                try {
                    const response = await fetch(`${baseURL}/api/stock/qr-code?no_part=${encodeURIComponent(noPart)}&no_project=${encodeURIComponent(noProject)}&rack=${rack}`);
                    const data = await response.json();
                    return data.qr_code || null;
                } catch (error) {
                    console.error('Error getting existing QR:', error);
                    return null;
                }
            }

            function renderRows(rows) {
                tbody.innerHTML = '';
                const filteredRows = rows.filter(r => {
                    // Solo productos en status "Shopping cart" con datos válidos
                    const hasData = r.no_part && r.description;
                    const statusVal = String(r.status || '').trim().toLowerCase();
                    const isShopping = statusVal === 'shopping cart';
                    return hasData && isShopping;
                });

                if (filteredRows.length === 0) {
                    tableWrapper.classList.add('hidden');
                    emptyState.classList.add('show');
                    return;
                }

                filteredRows.forEach(r => {
                    const tr = document.createElement('tr');
                    const rackSelect = document.querySelector('select[name="rackNumber"]');
                    const rack = rackSelect?.value || '';
                    
                    // Obtener QR existente de forma asíncrona
                    getExistingQR(r.no_part, projectSelect.value, rack).then(existingQR => {
                        const qrIdCell = tr.querySelector('td:nth-child(3)');
                        if (qrIdCell) {
                            qrIdCell.textContent = existingQR ? existingQR : '-';
                            qrIdCell.classList.add(existingQR ? 'text-success' : 'text-muted');
                        }
                    });

                    tr.innerHTML = `
                        <td>${safe(r.no_part)}</td>
                        <td>${safe(r.description)}</td>
                        <td>-</td>
                        <td>
                            <button type="button" class="btn btn-sm text-white" 
                                    style="background-color: #9333ea; border-color: #9333ea;" 
                                    onclick="generateQR('${safe(r.no_part)}')">
                                <i class="bi bi-qr-code me-1"></i>Generar QR
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                tableWrapper.classList.remove('hidden');
                emptyState.classList.remove('show');
            }

            projectSelect.addEventListener('change', () => {
                const pid = projectSelect.value;
                tbody.innerHTML = '';
                const rackSelect = document.querySelector('select[name="rackNumber"]');

                if (!pid) {
                    tableWrapper.classList.add('hidden');
                    emptyState.classList.remove('show');
                    rackSelect.disabled = false;
                    return;
                }

                // Obtener el rack usado por primera vez en este proyecto
                fetch(`${baseURL}/api/stock/first-rack?no_project=${encodeURIComponent(pid)}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.rack) {
                            // Proyecto ya tiene QRs - rellenar y deshabilitar
                            rackSelect.value = data.rack;
                            rackSelect.disabled = true;
                        } else {
                            // Proyecto nuevo - permitir seleccionar rack
                            rackSelect.disabled = false;
                            rackSelect.value = '';
                        }
                    })
                    .catch(err => {
                        console.error('Error getting first rack:', err);
                        rackSelect.disabled = false;
                    });

                fetch(`${baseURL}/api/purchases?projectId=${encodeURIComponent(pid)}`)
                    .then(res => res.json())
                    .then(rows => {
                        allRows = rows;
                        if (Array.isArray(rows) && rows.length > 0) {
                            renderRows(rows);
                        } else {
                            tableWrapper.classList.add('hidden');
                            emptyState.classList.add('show');
                        }
                    })
                    .catch(err => {
                        console.error('Error loading project purchases:', err);
                        tableWrapper.classList.add('hidden');
                        emptyState.classList.add('show');
                    });
            });

            // Evento para regenerar QR
            document.getElementById('confirmRegenerateBtn').addEventListener('click', () => {
                if (currentQRAction) {
                    confirmQRModal.hide();
                    displayExistingQRCode(currentQRAction);
                    currentQRAction = null;
                }
            });

            // Función para generar QR y guardar en stock
            window.generateQR = function (noPart) {
                const rackSelect = document.querySelector('select[name="rackNumber"]');
                const rack = rackSelect.value;
                const noProject = projectSelect.value;

                if (!rack) {
                    alert('Por favor selecciona un Rack Number');
                    return;
                }

                if (!noProject) {
                    alert('Por favor selecciona un proyecto');
                    return;
                }

                // Verificar si ya existe un QR previo
                getExistingQR(noPart, noProject, rack).then(existingQR => {
                    if (existingQR) {
                        // Si existe QR previo, mostrar confirmación
                        currentQRAction = {
                            qr_code: existingQR,
                            no_part: noPart,
                            rack: rack,
                            no_project: noProject
                        };
                        document.getElementById('existingQRId').textContent = existingQR;
                        confirmQRModal.show();
                    } else {
                        // Si no existe, crear uno nuevo
                        createNewQR(noPart, rack, noProject);
                    }
                });
            };

            // Función para crear un nuevo QR
            function createNewQR(noPart, rack, noProject) {
                // Preparar datos para enviar
                const data = {
                    rack: rack,
                    no_part: noPart,
                    no_project: noProject
                };

                // Enviar al servidor
                fetch(`${baseURL}/api/stock/entry`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(res => res.json())
                    .then(result => {
                        if (result.success) {
                            // Mostrar mensaje de éxito
                            alert(`QR generado exitosamente: ${result.data.qr_code}`);

                            // Actualizar la tabla para mostrar el nuevo QR
                            updateTableQRColumn(noPart, result.data.qr_code);

                            // Crear y mostrar el código QR visual
                            displayQRCode(result.data);
                        } else {
                            alert('Error al generar QR: ' + (result.error || 'Error desconocido'));
                        }
                    })
                    .catch(err => {
                        console.error('Error generating QR:', err);
                        alert('Error al conectar con el servidor');
                    });
            }

            // Función para actualizar la columna QR en la tabla
            function updateTableQRColumn(noPart, qrCode) {
                const rows = tbody.querySelectorAll('tr');
                rows.forEach(row => {
                    const partCell = row.querySelector('td:first-child');
                    if (partCell && partCell.textContent === noPart) {
                        const qrCell = row.querySelector('td:nth-child(3)');
                        if (qrCell) {
                            qrCell.textContent = qrCode;
                            qrCell.classList.remove('text-muted');
                            qrCell.classList.add('text-success');
                        }
                    }
                });
            }

            // Resaltar el último QR generado o re-generado
            function highlightCard(cardId) {
                document.querySelectorAll('.qr-card-highlight').forEach(card => {
                    card.classList.remove('qr-card-highlight');
                });

                const cardEl = document.getElementById(cardId);
                if (cardEl) {
                    cardEl.classList.add('qr-card-highlight');
                    cardEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            // Función para mostrar el código QR visual
            function displayQRCode(stockData) {
                const qrSection = document.getElementById('qrCodesSection');
                const qrContainer = document.getElementById('qrCodesContainer');

                // Mostrar la sección de QR
                qrSection.style.display = 'block';

                // Crear un div único para este QR
                const qrId = `qr-${stockData.qr_code}`;
                const cardId = `card-${stockData.qr_code}`;
                const qrDiv = document.createElement('div');
                qrDiv.className = 'col-md-4 col-lg-3 mb-4';
                qrDiv.innerHTML = `
                    <div class="card bg-dark text-white p-3 text-center" id="${cardId}">
                        <div id="${qrId}" class="mb-2 d-flex justify-content-center"></div>
                        <h6 class="mb-1">${stockData.qr_code}</h6>
                        <small class="text-muted">No. Part: ${stockData.no_part}</small>
                        <small class="text-muted">Rack: ${stockData.rack}</small>
                        <small class="text-muted">Proyecto: ${stockData.no_project}</small>
                    </div>
                `;

                qrContainer.appendChild(qrDiv);

                // Generar el QR code visual usando la librería QRCode.js
                setTimeout(() => {
                    new QRCode(document.getElementById(qrId), {
                        text: stockData.qr_code,
                        width: 150,
                        height: 150,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }, 100);

                // Resaltar este QR como el último mostrado
                highlightCard(cardId);
            }

            // Función para mostrar un QR existente
            function displayExistingQRCode(stockData) {
                const qrSection = document.getElementById('qrCodesSection');
                const qrContainer = document.getElementById('qrCodesContainer');

                // Mostrar la sección de QR
                qrSection.style.display = 'block';

                // Verificar si el QR ya está mostrado
                const existingQRId = `qr-${stockData.qr_code}`;
                const existingCard = document.getElementById(existingQRId)?.closest('.card');
                if (existingCard) {
                    // Si ya existe, solo resaltarlo y scrollear hacia él
                    highlightCard(existingCard.id);
                    return;
                }

                // Crear un div único para este QR
                const cardId = `card-${stockData.qr_code}`;
                const qrDiv = document.createElement('div');
                qrDiv.className = 'col-md-4 col-lg-3 mb-4';
                qrDiv.innerHTML = `
                    <div class="card bg-dark text-white p-3 text-center" id="${cardId}">
                        <div id="${existingQRId}" class="mb-2 d-flex justify-content-center"></div>
                        <h6 class="mb-1">${stockData.qr_code}</h6>
                        <small class="text-muted">No. Part: ${stockData.no_part}</small>
                        <small class="text-muted">Rack: ${stockData.rack}</small>
                        <small class="text-muted">Proyecto: ${stockData.no_project}</small>
                    </div>
                `;

                qrContainer.appendChild(qrDiv);

                // Generar el QR code visual usando la librería QRCode.js
                setTimeout(() => {
                    new QRCode(document.getElementById(existingQRId), {
                        text: stockData.qr_code,
                        width: 150,
                        height: 150,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }, 100);

                // Resaltar este QR como el último mostrado
                highlightCard(cardId);
            }
        });
    </script>
</body>

</html>