<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Purchase Records</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
</head>

<body class="bg-dark text-light">
  <!-- Barra de navegación -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-gradient">
    <div class="container-fluid px-4">
      <a href="index.html" class="p-0 me-4" title="Go to Home Page">
        <img src="logo.png" alt="Logo" height="40">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu"
        aria-controls="navbarMenu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarMenu">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="http://localhost:3000">Home</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              BOM
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="bom.html">Upload BOM</a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li><a class="dropdown-item" href="bomView.html">View BOM</a></li>
            </ul>
          </li>
          <li class="nav-item"><a class="nav-link active" href="#">Register Purchase</a></li>
          <li class="nav-item"><a class="nav-link" href="purchaseTracking.html">Purchase Tracking</a></li>
          <li class="nav-item"><a class="nav-link" href="stock.html">Inventory</a></li>
        </ul>
      </div>
      <!-- Título de la página -->
      <div class="d-flex align-items-center">
        <i class="bi bi-cart-plus-fill fs-4 me-2 text-white"></i>
        <span class="h4 mb-0 text-white">Register Purchase</span>
      </div>
    </div>
  </nav>

  <main class="container my-5">
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card shadow-lg p-4 bg-dark text-light">
          <h2 class="text-center mb-4 text-danger">New Purchase</h2>
          <form id="formCompra">
            <div class="mb-4">
              <div class="producto-item card bg-secondary mb-3 p-3">
                <div class="row">
                  <!-- Campo Project con autocompletado -->
                  <div class="col-md-6 mb-3" style="position: relative;">
                    <label>Project:</label>
                    <input type="text" class="form-control bg-dark text-light no_project"
                      placeholder="Search project..." autocomplete="off">
                    <div class="sugerencias-no-project bg-dark text-light"
                      style="position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; border: 1px solid #ccc; display: none; max-height: 200px; overflow-y: auto;">
                    </div>
                  </div>
                  <!-- Campo Type Product con autocompletado -->
                  <div class="col-md-6 mb-3" style="position: relative;">
                    <label>Type Product:</label>
                    <input type="text" class="form-control bg-dark text-light type_p-input"
                      placeholder="Search type product..." autocomplete="off" id="type_p_input">
                    <div class="sugerencias-type-p bg-dark text-light"
                      style="position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; border: 1px solid #ccc; display: none; max-height: 200px; overflow-y: auto;">
                    </div>
                  </div>
                </div>
                <!-- Select de vendors -->
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Vendor</label>
                    <select class="form-select bg-secondary text-light" name="id_vendor" required>
                      <option value="">Loading vendors...</option>
                    </select>
                  </div>
                <!-- Select de networks -->
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Network</label>
                    <select class="form-select bg-secondary text-light" name="network" id="networkSelect" required>
                      <option value="">Loading networks...</option>
                    </select>
                    <div id="balanceInfo" class="balance-info mt-2" style="display: none;">
                      <i class="bi bi-wallet2"></i> Available Balance: <span id="balanceAmount">$0.00</span>
                    </div>
                  </div>
                </div>
                <!-- Select del tipo de moneda -->
                <div class="mb-4">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label">Currency</label>
                      <select class="form-select bg-secondary text-light" name="currency" required>
                        <option value="">Select...</option>
                        <option value="USD">USD</option>
                        <option value="MXN">MXN</option>
                      </select>
                    </div>
                  <!-- Campo para ingresar PR -->
                    <div class="col-md-6 mb-3">
                      <label class="form-label">PR</label>
                      <input type="text" class="form-control bg-secondary text-light" name="pr" required>
                    </div>
                  </div>
                  <!-- Botón para agregar a la tabla -->
                  <div class="d-grid">
                    <button type="button" class="btn btn-outline-info btn-agregar-tabla">
                      <i class="bi bi-plus-circle"></i> Added
                    </button>
                  </div>
                </div>
                <!-- Tabla de productos -->
                <div class="mt-4">
                  <div class="table-responsive">
                    <table class="table table-custom" id="tablaProductos">
                      <thead>
                        <tr>
                          <th>Part Number</th>
                          <th>Brand</th>
                          <th>Description</th>
                          <th>Type</th>
                          <th>Quantity</th>
                          <th>Unit</th>
                          <th>Time Delivered</th>
                          <th>Price Unit</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                      <!-- Los productos se agregan a la tabla dinámicamente -->
                      </tbody>
                      <tfoot>
                        <tr class="total-row">
                          <td colspan="6" class="text-end"><strong>Total:</strong></td>
                          <td id="totalCompra">$0.00</td>
                          <td></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              </div>
              <!-- Botón para guardar la compra -->
              <div class="d-grid mb-3">
                <button type="submit" class="btn btn-danger btn-lg">Save Purchase</button>
              </div>
          </form>
        </div>
      </div>
    </div>
  </main>
  <footer class="text-center py-3 text-danger bg-dark">
    Automation Purchase - BRK. Resideo.
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const baseURL = 'http://localhost:3000/api';
      let productosEnTabla = []; 

      // Función para calcular y actualizar el total 
      function actualizarTotal() {
        let total = 0;
        productosEnTabla.forEach(producto => {
          total += producto.subtotal;
        });
        document.getElementById('totalCompra').textContent = `$${total.toFixed(2)}`;
        return total;
      }

      // Autocompletados
      function inicializarAutocompletado(inputNoPart, inputDescripcion, contenedorSugerencias) {
        if (!inputNoPart) return;
        inputNoPart.addEventListener('input', async () => {
          const term = inputNoPart.value.trim();
          inputDescripcion.value = '';
          if (!term) {
            contenedorSugerencias.style.display = 'none';
            return;
          }
          try {
            const res = await fetch(`${baseURL}/products/search?term=${encodeURIComponent(term)}`);
            const data = await res.json();
            contenedorSugerencias.innerHTML = '';
            data.forEach(item => {
              const div = document.createElement('div');
              div.textContent = `${item.no_part} - ${item.description}`;
              div.style.padding = '5px';
              div.style.cursor = 'pointer';
              div.addEventListener('click', () => {
                inputNoPart.value = item.no_part;
                inputDescripcion.value = item.description;
                contenedorSugerencias.style.display = 'none';
              });
              contenedorSugerencias.appendChild(div);
            });
            contenedorSugerencias.style.display = data.length ? 'block' : 'none';
          } catch (err) {
            console.error(err);
          }
        });

        document.addEventListener('click', (e) => {
          if (contenedorSugerencias && !contenedorSugerencias.contains(e.target) && e.target !== inputNoPart) {
            contenedorSugerencias.style.display = 'none';
          }
        });
      }

      function inicializarAutocompletadoProyectos(inputProject, contenedorSugerencias, hiddenProjectName) {
        inputProject.addEventListener('input', async () => {
          const term = inputProject.value.trim();
          hiddenProjectName.value = '';
          if (!term) {
            contenedorSugerencias.style.display = 'none';
            return;
          }
          try {
            const res = await fetch(`${baseURL}/projects/search?term=${encodeURIComponent(term)}`);
            const data = await res.json();
            contenedorSugerencias.innerHTML = '';
            data.forEach(item => {
              const div = document.createElement('div');
              div.textContent = `${item.no_project} - ${item.name_project}`;
              div.style.padding = '5px';
              div.style.cursor = 'pointer';
              div.addEventListener('click', () => {
                inputProject.value = item.no_project;
                hiddenProjectName.value = item.name_project;
                contenedorSugerencias.style.display = 'none';
              });
              contenedorSugerencias.appendChild(div);
            });
            contenedorSugerencias.style.display = data.length ? 'block' : 'none';
          } catch (err) {
            console.error(err);
          }
        });

        document.addEventListener('click', (e) => {
          if (contenedorSugerencias && !contenedorSugerencias.contains(e.target) && e.target !== inputProject) {
            contenedorSugerencias.style.display = 'none';
          }
        });
      }

      function inicializarAutocompletadoTypeP(inputTypeP, contenedorSugerencias) {
        inputTypeP.addEventListener('input', async () => {
          const term = inputTypeP.value.trim();
          if (!term) {
            contenedorSugerencias.style.display = 'none';
            return;
          }

          try {
            const res = await fetch(`${baseURL}/products/types?term=${encodeURIComponent(term)}`);
            const data = await res.json();

            contenedorSugerencias.innerHTML = '';
            data.forEach(item => {
              const div = document.createElement('div');
              div.textContent = item.type_p;
              div.style.padding = '5px';
              div.style.cursor = 'pointer';
              div.addEventListener('click', () => {
                inputTypeP.value = item.type_p;
                // Se guarda el tipo de producto seleccionado
                tipoProductoSeleccionado = item.type_p;
                contenedorSugerencias.style.display = 'none';
              });
              contenedorSugerencias.appendChild(div);
            });

            contenedorSugerencias.style.display = data.length ? 'block' : 'none';

          } catch (err) {
            console.error(err);
          }
        });

        document.addEventListener('click', (e) => {
          if (contenedorSugerencias && !contenedorSugerencias.contains(e.target) && e.target !== inputTypeP) {
            contenedorSugerencias.style.display = 'none';
          }
        });
      }

      //Inicializar autocompletados en DOM
      const projectInput = document.querySelector('.no_project');
      const projectSugerenciasDiv = document.querySelector('.sugerencias-no-project');
      const projectNameInput = document.createElement('input');
      projectNameInput.type = 'hidden';
      projectNameInput.className = 'project-name-input';
      projectNameInput.name = 'project_name';
      if (projectInput) projectInput.parentNode.appendChild(projectNameInput);
      inicializarAutocompletadoProyectos(projectInput, projectSugerenciasDiv, projectNameInput);

      const typePInput = document.querySelector('.type_p-input');
      const typePSugerenciasDiv = document.querySelector('.sugerencias-type-p');
      const typePHiddenInput = document.createElement('input');
      typePHiddenInput.type = 'hidden';
      typePHiddenInput.className = 'type_p-hidden-input';
      typePHiddenInput.name = 'type_p';
      if (typePInput) typePInput.parentNode.appendChild(typePHiddenInput);
      inicializarAutocompletadoTypeP(typePInput, typePSugerenciasDiv);

      // Mantener hidden sincronizado
      if (typePInput) {
        typePInput.addEventListener('input', function () {
          typePHiddenInput.value = this.value;
          // Actualizar valor seleccionado cuando el usuario escribe directamente
          tipoProductoSeleccionado = this.value;
        });
      }

      //Cálculo del BOM + Producto
      let tipoProductoSeleccionado = "";

      // Función para cargar productos con cálculo BOM
      async function cargarProductosConBOM(no_project, type_p) {
        try {
          const res = await fetch(
            `${baseURL}/products/bom-calculation?no_project=${encodeURIComponent(no_project)}&type_p=${encodeURIComponent(type_p)}`
          );
          if (!res.ok) throw new Error('Error fetching BOM calculation');
          const productos = await res.json();
          return productos;
        } catch (err) {
          console.error('Error cargarProductosConBOM:', err);
          return [];
        }
      }
      
      // Función para agregar producto con cálculo aplicado
      function agregarProductoConCalculo(producto) {
        const tablaBody = document.querySelector("#tablaProductos tbody");
        if (!tablaBody) return;

        // Usar quantity_calculated del backend (quantity_project / quantity)
                const quantityFinal = Math.ceil(producto.quantity_calculated || 0);

        // Escapar texto
        const esc = (s) => (s === null || s === undefined) ? '' : String(s).replace(/</g, "&lt;").replace(/>/g, "&gt;");

        // Mostrar en la tabla con quantity calculado
        const filaHTML = `
          <tr>
            <td class="cell-no-part">${esc(producto.no_part)}</td>
            <td>${esc(producto.brand)}</td>
            <td>${esc(producto.description)}</td>
            <td>${esc(producto.type_p)}</td>
            <td class="cell-quantity">${quantityFinal.toFixed(2)}</td>
            <td>${esc(producto.unit)}</td>
            <td><input type="date" class="form-control time-delivered" /></td>
            <td><input type="text" inputmode="decimal" class="form-control form-control-sm price" placeholder="0.00" autocomplete="off" style="width: 100px"></td>
            <td><button type="button" class="btn btn-sm btn-outline-danger btn-remove"><i class="bi bi-trash"></i></button></td>
          </tr>
        `;

        tablaBody.insertAdjacentHTML("beforeend", filaHTML);

        // Obtener la fila recién agregada
        const nuevaFila = tablaBody.lastElementChild;

        // Crear un objeto del producto con el quantity calculado
        const productoObj = {
          no_part: producto.no_part,
          brand: producto.brand,
          description: producto.description,
          type_p: producto.type_p,
          quantity: quantityFinal, //Se usa quantity calculado
          unit: producto.unit,
          price_unit: 0,
          time_delivered_product: null,
          subtotal: 0
        };

        productosEnTabla.push(productoObj);
        actualizarTotal();

        // Manejo del input precio
        const priceInput = nuevaFila.querySelector('.price');
        priceInput.addEventListener('input', () => {
          const raw = priceInput.value || '';
          const val = parseFloat(raw.replace(/[^0-9.-]+/g, '')) || 0;
          productoObj.price_unit = val;
          productoObj.subtotal = val * productoObj.quantity;
          actualizarTotal();
        });

        // Manejo del botón eliminar
        const btn = nuevaFila.querySelector('.btn-remove');
        btn.addEventListener('click', () => {
          nuevaFila.remove(); // Remover del DOM
          const idx = productosEnTabla.indexOf(productoObj);
          if (idx !== -1) productosEnTabla.splice(idx, 1);
          actualizarTotal();
        });
      }

      // Función OLD (mantenida por compatibilidad)
      function agregarProductoATabla(producto) {
        const tablaBody = document.querySelector("#tablaProductos tbody");
        if (!tablaBody) return;

        const esc = (s) => (s === null || s === undefined) ? '' : String(s).replace(/</g, "&lt;").replace(/>/g, "&gt;");

        const filaHTML = `
          <tr>
            <td class="cell-no-part">${esc(producto.no_part)}</td>
            <td>${esc(producto.brand)}</td>
            <td>${esc(producto.description)}</td>
            <td>${esc(producto.type_p)}</td>
            <td class="cell-quantity">${esc(producto.quantity)}</td>
            <td>${esc(producto.unit)}</td>
            <td><input type="date" class="form-control time-delivered" /></td>
            <td><input type="text" inputmode="decimal" class="form-control form-control-sm price" placeholder="0.00" autocomplete="off" style="width: 100px"></td>
            <td><button type="button" class="btn btn-sm btn-outline-danger btn-remove"><i class="bi bi-trash"></i></button></td>
          </tr>
        `;

        tablaBody.insertAdjacentHTML("beforeend", filaHTML);

        const nuevaFila = tablaBody.lastElementChild;

        const productoObj = {
          no_part: producto.no_part,
          brand: producto.brand,
          description: producto.description,
          type_p: producto.type_p,
          quantity: Number(producto.quantity) || 0,
          unit: producto.unit,
          price_unit: 0,
          time_delivered_product: null,
          subtotal: 0
        };

        productosEnTabla.push(productoObj);
        actualizarTotal();

        const priceInput = nuevaFila.querySelector('.price');
        priceInput.addEventListener('input', () => {
          const raw = priceInput.value || '';
          const val = parseFloat(raw.replace(/[^0-9.-]+/g, '')) || 0;
          productoObj.price_unit = val;
          productoObj.subtotal = val * productoObj.quantity;
          actualizarTotal();
        });

        const btn = nuevaFila.querySelector('.btn-remove');
        btn.addEventListener('click', () => {
          nuevaFila.remove();
          const idx = productosEnTabla.indexOf(productoObj);
          if (idx !== -1) productosEnTabla.splice(idx, 1);
          actualizarTotal();
        });

        // Manejo del input de fecha
        const dateInput = nuevaFila.querySelector('.time-delivered');
        dateInput.addEventListener('change', () => {
          productoObj.time_delivered = dateInput.value;   
        });

      }

      // Evento botón para agregar
      const btnAgregar = document.querySelector('.btn-agregar-tabla');
      if (btnAgregar) {
        btnAgregar.addEventListener('click', async () => {
          // Obtener proyecto y tipo
          const no_project = document.querySelector('.no_project').value.trim();
          const type_p = tipoProductoSeleccionado;

          if (!no_project || !type_p) {
            alert('Select a project');
            return;
          }

          // llamar backend con cálculo BOM
          const productos = await cargarProductosConBOM(no_project, type_p);
          if (!productos || productos.length === 0) {
            alert('No products were found that match the BOM.');
            return;
          }
          // Añadir a la tabla con cálculo
          productos.forEach(prod => agregarProductoConCalculo(prod));
        });
      }
      // Carga inicial de selects (vendors, networks)
      fetch(`${baseURL}/vendors`).then(r => r.json()).then(data => {
        const vendorSelect = document.querySelector('select[name="id_vendor"]');
        if (!vendorSelect) return;
        vendorSelect.innerHTML = '<option value="">Select vendor...</option>';
        data.forEach(v => vendorSelect.innerHTML += `<option value="${v.id_vendor}">${v.name_vendor}</option>`);
      }).catch(err => console.error(err));

      fetch(`${baseURL}/networks`).then(r => r.json()).then(data => {
        const networkSelect = document.querySelector('select[name="network"]');
        if (!networkSelect) return;
        networkSelect.innerHTML = '<option value="">Select network...</option>';
        data.forEach(n => networkSelect.innerHTML += `<option value="${n.network}">${n.network}</option>`);
      }).catch(err => console.error(err));

      // Evento para mostrar el balance al seleccionar una network 
      const networkSelectElem = document.getElementById('networkSelect');
      if (networkSelectElem) {
        networkSelectElem.addEventListener('change', function () {
          const network = this.value;
          if (network) {
            fetch(`${baseURL}/network/balance/${encodeURIComponent(network)}`)
              .then(r => r.json())
              .then(data => {
                document.getElementById('balanceAmount').textContent = `$${parseFloat(data.balance).toFixed(2)}`;
                document.getElementById('balanceInfo').style.display = 'block';
              })
              .catch(err => {
                console.error('Error fetching balance:', err);
                document.getElementById('balanceInfo').style.display = 'none';
              });
          } else {
            document.getElementById('balanceInfo').style.display = 'none';
          }
        });
      }

      function obtenerFechaMasTardia() {
        const fechas = Array.from(document.querySelectorAll(".time-delivered"))
          .map(input => input.value)
          .filter(v => v); // Quita vacíos

        if (fechas.length === 0) return null;

        // Toma la fecha más tardía
        let maxFecha = fechas.reduce((a, b) => (a > b ? a : b));
        return maxFecha;
      }

      //Envío del formulario
      document.getElementById('formCompra').addEventListener('submit', async function (e) {
        e.preventDefault();

        // Insertar las fechas al array productosEnTabla
        const filas = document.querySelectorAll("#tablaProductos tbody tr");
        const fechaTotal= obtenerFechaMasTardia();

        filas.forEach((fila, index) => {
          const fecha = fila.querySelector(".time-delivered").value || null;
          productosEnTabla[index].time_delivered_product = fecha;
        })

        // Verificar que hay productos en la tabla
        if (productosEnTabla.length === 0) {
          alert('Add at least one product to the table before saving.');
          return;
        }

        const totalCompra = actualizarTotal();
        const network = document.querySelector('select[name="network"]').value;

        // Obtener balance actual para validación
        let balanceActual = 0;
        if (network) {
          try {
            const balanceRes = await fetch(`${baseURL}/network/balance/${encodeURIComponent(network)}`);
            const balanceData = await balanceRes.json();
            balanceActual = parseFloat(balanceData.balance);
          } catch (err) {
            console.error('Error fetching balance:', err);
          }
        }

        const confirmMessage = `Are you sure you want to save this purchase?\n\nTotal: $${totalCompra.toFixed(2)}\nAvaliable Balance: $${balanceActual.toFixed(2)}\nRemaining Balance: $${(balanceActual - totalCompra).toFixed(2)}`;

        const confirmSave = confirm(confirmMessage);
        if (!confirmSave) {
          return;
        }

        const form = e.target;
        const formData = Object.fromEntries(new FormData(form).entries());

        // Agregar productos al formData desde productosEnTabla
        formData.productos = productosEnTabla.map(p => ({
          no_part: p.no_part,
          description: p.description,
          quantity: p.quantity,
          price_unit: p.price_unit,
          time_delivered_product: p.time_delivered_product,
        }));

        const no_project = document.querySelector('.no_project').value.trim();
        formData.time_delivered= fechaTotal;
        formData.no_project= no_project;
        formData.status= "PR";


        const button = form.querySelector('button[type="submit"]');
        button.disabled = true;
        button.textContent = 'Saving...';

        try {
          const res = await fetch(`${baseURL}/purchases`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });
          const result = await res.json();
          if (result.success) {
            alert(`Purchase succesfully saved!\nTotal: $${result.total_amount.toFixed(2)}\nBalance: $${result.new_balance.toFixed(2)}`);
            document.querySelector('#tablaProductos tbody').innerHTML = '';
            productosEnTabla = [];
            actualizarTotal();
            document.getElementById('balanceInfo').style.display = 'none';
            form.reset();
            setTimeout(() => window.location.href = 'purchaseTracking.html', 2000);
          } else {
            alert('Error: ' + result.error);
          }
        } catch (err) {
          console.error(err);
          alert('Connection error with server');
        } finally {
          button.disabled = false;
          button.textContent = 'Save Purchase';
        }
      });
    });
  </script>
</body>

</html>